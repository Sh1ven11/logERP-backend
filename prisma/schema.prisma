generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

//
// =========================
//         MODELS
// =========================
//

model User {
  id        Int            @id @default(autoincrement())
  username  String         @unique
  password  String
  createdAt DateTime       @default(now())
  refreshToken  String?  // stored hashed refresh token

  // Relations
  companies            UserCompany[]
  createdConsignments  ConsignmentNote[] @relation("UserCreatedConsignments")

  // ⭐ ADDED
  createdLorryHireChallans LorryHireChallan[] @relation("UserCreatedLorryHireChallan")
}

model UserCompany {
  id        Int       @id @default(autoincrement())

  userId    Int
  companyId Int
  role      String    @default("user")

  user      User      @relation(fields: [userId], references: [id])
  company   Company   @relation(fields: [companyId], references: [id])

  @@unique([userId, companyId])
}

model Company {
  id        Int       @id @default(autoincrement())
  name      String
  code      String    @unique
  address   String?
  phone     String?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  branches          Branch[]
  users             UserCompany[]
  financialYears    FinancialYear[]
  consignmentNotes  ConsignmentNote[]
  customers         Customer[]
  brokers           Broker[]
  customerGroups    CustomerGroup[]
  lorryOwners       LorryOwner[]
  invoices Invoice[]

  // ⭐ ADDED
  lorryHireChallans LorryHireChallan[]
}

model Branch {
  id        Int       @id @default(autoincrement())
  name      String
  code      String    @unique
  address   String?
  phone     String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  companyId Int
  company   Company   @relation(fields: [companyId], references: [id])

  consignmentNotes ConsignmentNote[]
  customers        Customer[]
  brokers          Broker[]
  invoices Invoice[]


  // ⭐ ADDED
  lorryHireChallans LorryHireChallan[]
}

model FinancialYear {
  id         Int      @id @default(autoincrement())
  yearLabel  String

  startDate  DateTime
  endDate    DateTime

  companyId  Int
  company    Company  @relation(fields: [companyId], references: [id])

  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  consignmentNotes ConsignmentNote[]

  // ⭐ ADDED
  lorryHireChallans LorryHireChallan[]
}

model Destination {
  id        Int      @id @default(autoincrement())
  name      String
  state     String?
  pincode   String?

  isActive  Boolean  @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  consignmentsFrom ConsignmentNote[] @relation("FromDestination")
  consignmentsTo   ConsignmentNote[] @relation("ToDestination")

  // ⭐ ADDED
  lorryHireChallans LorryHireChallan[]
}

model Customer {
  id           Int      @id @default(autoincrement())
  companyCode  String   @unique
  companyName  String
  billName     String
  address1     String?
  address2     String?
  address3     String?
  phone        String?
  debit        Float    @default(0)
  credit       Float    @default(0)
  creditDays   Int?
  interestRate Float?

  groupId    Int?
  group      CustomerGroup? @relation(fields: [groupId], references: [id])

  companyId  Int
  branchId   Int?

  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  company   Company @relation(fields: [companyId], references: [id])
  branch    Branch? @relation(fields: [branchId], references: [id])
  invoices Invoice[]

  consignmentsAsConsignor  ConsignmentNote[] @relation("ConsignorRelation")
  consignmentsAsConsignee  ConsignmentNote[] @relation("ConsigneeRelation")
}

model CustomerGroup {
  id        Int       @id @default(autoincrement())
  name      String
  companyId Int

  company   Company  @relation(fields: [companyId], references: [id])
  customers Customer[]
}

model Broker {
  id            Int      @id @default(autoincrement())
  brokerCode    String   @unique
  name          String
  address       String
  phoneNo       String
  panCard       String?
  tdsPercentage Float    @default(0)
  notes         String?

  companyId Int
  branchId  Int?

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  company  Company @relation(fields: [companyId], references: [id])
  branch   Branch? @relation(fields: [branchId], references: [id])

  consignmentNotes ConsignmentNote[]

  // ⭐ ADDED
  lorryHireChallans LorryHireChallan[]
}

model LorryOwner {
  id         Int      @id @default(autoincrement())
  name       String

  address1   String?
  address2   String?
  address3   String?

  panNumber  String?   @unique

  companyId  Int
  company    Company   @relation(fields: [companyId], references: [id])

  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  // ⭐ ADDED
  lorryHireChallans LorryHireChallan[]
}

//
// Logistics - Consignment Note
//
model ConsignmentNote {
  id              Int      @id @default(autoincrement())
  cnNumber        String

  @@unique([companyId, financialYearId, cnNumber])

  date            DateTime
  financialYearId Int
  companyId       Int
  branchId        Int
  consignorId     Int
  consigneeId     Int

  fromDestinationId Int
  toDestinationId   Int

  fromDestination Destination @relation("FromDestination", fields: [fromDestinationId], references: [id])
  toDestination   Destination @relation("ToDestination", fields: [toDestinationId], references: [id])

  packages        Int
  packageUom      String
  contents        String?

  gstPayableAt    String?
  netWeight       Float?
  grossWeight     Float?
  chargeWeight    Float?
  weightUom       String

  rate            Float?
  rateOn          String?
  freightCharges  Float?

  vehicleNo       String?
  driverName      String?
  remarks         String?

  brokerId        Int?
  createdByUserId Int

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  company         Company        @relation(fields: [companyId], references: [id])
  branch          Branch         @relation(fields: [branchId], references: [id])
  consignor       Customer       @relation("ConsignorRelation", fields: [consignorId], references: [id])
  consignee       Customer       @relation("ConsigneeRelation", fields: [consigneeId], references: [id])
  broker          Broker?        @relation(fields: [brokerId], references: [id])
  financialYear   FinancialYear  @relation(fields: [financialYearId], references: [id])
  createdBy       User           @relation("UserCreatedConsignments", fields: [createdByUserId], references: [id])

  // ⭐ ADDED
  lorryHireChallanConsignments LorryHireChallanConsignment[]
  invoiceConsignments InvoiceConsignment[]

}

model LorryHireChallan {
  id              Int      @id @default(autoincrement())
  challanNumber   String
  challanDate     DateTime
  lorryHireDate   DateTime?

  vehicleNo       String
  slipNo          String?
  remarks         String?

  lorryOwnerId    Int
  lorryOwner      LorryOwner @relation(fields: [lorryOwnerId], references: [id])

  brokerId        Int?
  broker          Broker?    @relation(fields: [brokerId], references: [id])

  panCardUsed     String?
  tdsApplicable   Boolean @default(false)
  tdsPercent      Float?

  destinationId   Int
  destination     Destination @relation(fields: [destinationId], references: [id])

  totalPackages   Int?    @default(0)
  totalWeight     Float?  @default(0)
  rate            Float?
  lorryHire       Float?
  advancePaid     Float?  @default(0)
  balancePayable  Float?  @default(0)

  loadingCharges   Float? @default(0)
  unloadingCharges Float? @default(0)
  dieselAdvance    Float? @default(0)

  gstApplicable    Boolean @default(false)
  gstAmount        Float?  @default(0)

  isSettled        Boolean @default(false)
  paymentDate      DateTime?

  consignmentCount Int?    @default(0)

  companyId        Int
  branchId         Int
  financialYearId  Int

  company          Company       @relation(fields: [companyId], references: [id])
  branch           Branch        @relation(fields: [branchId], references: [id])
  financialYear    FinancialYear @relation(fields: [financialYearId], references: [id])

  consignments     LorryHireChallanConsignment[]

  createdByUserId  Int
  createdBy        User @relation("UserCreatedLorryHireChallan", fields: [createdByUserId], references: [id])

  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
}

model LorryHireChallanConsignment {
  id            Int @id @default(autoincrement())
  challanId     Int
  consignmentId Int

  challan       LorryHireChallan @relation(fields: [challanId], references: [id])
  consignment   ConsignmentNote  @relation(fields: [consignmentId], references: [id])

  @@unique([challanId, consignmentId])
}
model Invoice {
  id              Int      @id @default(autoincrement())
  invoiceNo       Int
  invoiceDate     DateTime @default(now())
  
  companyId       Int
  branchId        Int
  customerId      Int

  billAmount      Float    @default(0)
  balanceAmount   Float    @default(0)
  deduction       Float    @default(0)
  tdsDeducted     Float    @default(0)
  creditDays      Int?

  stagingChargeRate Float?    // st_rate
  stagingChargeAmount Float?  // st_amount
  csRate           Float?     @default(0)
  
  insurance        Float? @default(0)
  otherCharges     Float? @default(0)

  gstPercent       Float?
  gstAmount        Float?

  finalAmount      Float? @default(0)

  remarks          String?
  notes            String?

  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  // RELATIONS
  company      Company   @relation(fields: [companyId], references: [id])
  branch       Branch    @relation(fields: [branchId], references: [id])
  customer     Customer  @relation(fields: [customerId], references: [id])
  consignments InvoiceConsignment[]

}

model InvoiceConsignment {
  id            Int  @id @default(autoincrement())
  invoiceId     Int
  consignmentId Int

  invoice       Invoice         @relation(fields: [invoiceId], references: [id])
  consignment   ConsignmentNote @relation(fields: [consignmentId], references: [id])

  @@unique([invoiceId, consignmentId])
}
